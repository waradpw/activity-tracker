<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Habits Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #2563eb;
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-border: #e0e0e0;
            --color-success: #10b981;
            --color-light-blue: #dbeafe;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }

        /* Navigation Bar */
        .navbar {
            display: flex;
            gap: 0;
            background: var(--color-surface);
            border-bottom: 2px solid var(--color-border);
            margin-bottom: 20px;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            background: var(--color-light-blue);
            color: var(--color-primary);
            border: none;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-tab:hover {
            background: #bfdbfe;
        }

        .nav-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Yearly Tracker Grid */
        .yearly-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 2000px;
            margin: 0 auto;
        }

        .month-card {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 6px solid var(--color-primary);
        }

        .month-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .month-card.excellent {
            border-left-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
        }

        .month-card.good {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        }

        .month-card.fair {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
        }

        .month-card.poor {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
        }

        .month-year {
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }

        .month-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 6px;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            color: var(--color-primary);
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }

        .month-percentage {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 8px;
        }

        .yearly-header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            background: var(--color-surface);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .yearly-header h2 {
            font-size: 24px;
            margin: 0 0 10px 0;
            color: var(--color-text);
        }

        .yearly-header p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 1fr;
            gap: 20px;
            max-width: 2000px;
            margin: 0 auto;
        }

        .header {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .header p {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        /* Left Panel - Daily Habits */
        .habits-panel {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .habits-panel h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .habits-list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #f5f5f5;
            transition: background 0.2s;
            font-size: 13px;
            position: relative;
            user-select: none;
            gap: 10px;
        }

        .habit-item:hover {
            background: #efefef;
        }

        .habit-item.context-menu-open {
            background: #e8e8e8;
        }

        .habit-icon {
            font-size: 20px;
            margin-right: 10px;
            min-width: 24px;
        }

        .habit-name {
            flex: 1;
            font-weight: 500;
            word-break: break-word;
        }

        .habit-delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .habit-delete-btn:hover {
            background: #ee5a6f;
        }

        .context-menu {
            position: absolute;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 13px;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: var(--color-light-blue);
        }

        .context-menu-item.delete {
            color: #ff4757;
        }

        .context-menu-item.delete:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        /* Middle Panel - Weekly Tracking Grid */
        .tracking-grid-panel {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .tracking-grid-panel h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .weeks-container {
            display: flex;
            gap: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .week {
            flex: 0 0 auto;
            min-width: 350px;
        }

        .week-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .week-dates {
            font-size: 11px;
            color: #999;
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
            margin-top: 3px;
        }

        .day-header {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .tracking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .tracking-table thead {
            background: var(--color-light-blue);
        }

        .tracking-table th {
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            font-size: 11px;
        }

        .tracking-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .habit-row-label {
            text-align: left;
            padding-left: 8px;
            font-weight: 500;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-success);
        }

        .checkbox:checked {
            accent-color: var(--color-success);
        }

        /* Right Panel - Analytics */
        .analytics-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chart-card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .small-chart-container {
            position: relative;
            height: 200px;
        }

        .progress-card {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .top-habit {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        .top-habit:last-child {
            border-bottom: none;
        }

        .habit-rank {
            background: var(--color-primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
            font-size: 12px;
        }

        .habit-name-progress {
            flex: 1;
            font-weight: 500;
        }

        .habit-completion {
            color: var(--color-primary);
            font-weight: 600;
            font-size: 12px;
        }

        .month-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--color-light-blue);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .month-progress-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
        }

        .month-progress-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
            flex: 1;
        }

        .btn-icon {
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--color-light-blue);
            color: var(--color-primary);
        }

        .btn-secondary:hover {
            background: #bfdbfe;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-text);
        }

        .form-group input,
        .form-group textarea {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--color-text);
        }

        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        /* Toast Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
            max-width: 300px;
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ff4757;
        }

        .notification.info {
            background: #2563eb;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr;
            }

            .weeks-container {
                flex-wrap: wrap;
            }

            .week {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .habits-panel {
                max-height: 300px;
            }

            .chart-card {
                padding: 15px;
            }

            .chart-container,
            .small-chart-container {
                height: 200px;
            }
        }

        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <button class="nav-tab active" onclick="switchPage('daily')">üìä Daily Tracker</button>
        <button class="nav-tab" onclick="switchPage('yearly')">üìà Yearly Tracker</button>
    </div>

    <!-- Daily Tracker Page -->
    <div id="daily" class="page active">
        <div class="container">
            <div class="header">
                <h1>Daily Habits Tracker</h1>
                <p>Track your daily habits and monitor weekly progress with detailed analytics</p>
            </div>

        <!-- Left Panel - Daily Habits List -->
        <div class="habits-panel">
            <h2>Daily Habits</h2>
            <div class="habits-list-container" id="habitsList"></div>
            <div class="button-group-vertical">
                <button class="btn btn-primary btn-icon" onclick="openAddHabitModal()">+ Add Habit</button>
                <button class="btn btn-secondary btn-icon" onclick="openAddWeekModal()">üìÖ Add Week</button>
            </div>
        </div>

        <!-- Middle Panel - Weekly Tracking Grid -->
        <div class="tracking-grid-panel">
            <h2>Weekly Tracking</h2>
            <div class="weeks-container" id="weeksContainer"></div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousWeek()">‚Üê Previous Week</button>
                <button class="btn btn-secondary" onclick="nextWeek()">Next Week ‚Üí</button>
                <span style="align-self: center; color: #666; font-size: 12px; margin-left: 10px;" id="weekCountDisplay">Total Weeks: 5</span>
            </div>
        </div>

        <!-- Right Panel - Analytics -->
        <div class="analytics-panel">
            <div class="chart-card">
                <h3>Monthly Progress</h3>
                <div class="month-progress">
                    <div class="month-progress-label">Overall Completion</div>
                    <div class="month-progress-value" id="monthlyPercentage">0%</div>
                </div>
                <div class="small-chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Weekly Completion Rates</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="progress-card">
                <h3>Top 10 Daily Habits</h3>
                <div id="topHabits"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Yearly Tracker Page -->
    <div id="yearly" class="page">
        <div class="yearly-header">
            <h2>üìÖ Yearly Habits Progress</h2>
            <p>Your monthly completion rates from December 2025 onwards</p>
        </div>
        <div class="yearly-container" id="yearlyContainer"></div>
    </div>

    <!-- Add Habit Modal -->
    <div class="modal" id="addHabitModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddHabitModal()">&times;</span>
            <div class="modal-header">Add New Habit</div>
            <div class="form-group">
                <label>Habit Name</label>
                <input type="text" id="habitNameInput" placeholder="e.g., Wake up at 6AM">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="addHabit(); return false;">Add Habit</button>
                <button class="btn btn-secondary" onclick="closeAddHabitModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Week Modal -->
    <div class="modal" id="addWeekModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddWeekModal()">&times;</span>
            <div class="modal-header">Add New Week</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">All habits will start unchecked for the new week.</p>
            <div class="button-group">
                <button class="btn btn-primary" onclick="addWeek()">Add Week</button>
                <button class="btn btn-secondary" onclick="closeAddWeekModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Habit Modal -->
    <div class="modal" id="editHabitModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditHabitModal()">&times;</span>
            <div class="modal-header">Edit Habit</div>
            <div class="form-group">
                <label>Habit Name</label>
                <input type="text" id="editHabitNameInput" placeholder="e.g., Wake up at 6AM">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="saveEditedHabit(); return false;">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditHabitModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let habits = [
            { id: 1, name: 'Wake up at 6AM' },
            { id: 2, name: 'No Snooping' },
            { id: 3, name: 'Drink 3L Water' },
            { id: 4, name: 'Gym Workout' },
            { id: 5, name: 'Stretching' },
            { id: 6, name: 'Read 10 Pages' },
            { id: 7, name: 'Meditation' },
            { id: 8, name: 'Study 1 Hour' },
            { id: 9, name: 'Skincare Routine' },
            { id: 10, name: 'Limit Social Media' },
            { id: 11, name: 'No Alcohol' },
            { id: 12, name: 'Track Expenses' }
        ];

        // Tracking data: week -> day -> habit -> completed
        let trackingData = {};
        let totalWeeks = 5;
        let weekDates = {};

        // Initialize tracking data
        function initializeTrackingData() {
            const weeks = totalWeeks;
            const days = 7;
            for (let w = 1; w <= weeks; w++) {
                if (!trackingData[w]) {
                    trackingData[w] = {};
                    for (let d = 1; d <= days; d++) {
                        trackingData[w][d] = {};
                        habits.forEach(habit => {
                            trackingData[w][d][habit.id] = false;
                        });
                    }
                }
            }
        }

        let currentWeekStart = 1;

        // Render habits list
        function renderHabits() {
            const habitsList = document.getElementById('habitsList');
            if (habits.length === 0) {
                habitsList.innerHTML = '<div style="padding: 10px; color: #999; text-align: center;">No habits yet</div>';
            } else {
                habitsList.innerHTML = habits.map(habit => {
                    const escapedName = habit.name.replace(/'/g, "\\'");
                    return `
                    <div class="habit-item">
                        <span class="habit-name">${habit.name}</span>
                        <button class="habit-delete-btn" style="background: #3498db; margin-right: 5px;" onclick="openEditHabitModal(${habit.id}, '${escapedName}')">‚úèÔ∏è Edit</button>
                        <button class="habit-delete-btn" onclick="deleteHabit(${habit.id}, '${escapedName}')">üóëÔ∏è Delete</button>
                    </div>
                    `;
                }).join('');
            }
        }

        // Render weeks
        function renderWeeks() {
            const weeksContainer = document.getElementById('weeksContainer');
            weeksContainer.innerHTML = '';
            document.getElementById('weekCountDisplay').textContent = `Total Weeks: ${totalWeeks}`;

            for (let w = currentWeekStart; w < currentWeekStart + 3 && w <= totalWeeks; w++) {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'week';
                const dayNames = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

                let tableHTML = `
                    <div class="week-header">Week ${w}<div class="week-dates">${getDateRange(w)}</div></div>
                    <table class="tracking-table">
                        <thead>
                            <tr>
                                <th>Habits</th>
                                ${dayNames.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                habits.forEach(habit => {
                    tableHTML += '<tr>';
                    tableHTML += `<td class="habit-row-label">${habit.name}</td>`;
                    for (let d = 1; d <= 7; d++) {
                        const isCompleted = trackingData[w][d][habit.id];
                        tableHTML += `
                            <td>
                                <input type="checkbox" class="checkbox" ${isCompleted ? 'checked' : ''} 
                                    onchange="toggleTracking(${w}, ${d}, ${habit.id})">
                            </td>
                        `;
                    }
                    tableHTML += '</tr>';
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                weekDiv.innerHTML = tableHTML;
                weeksContainer.appendChild(weekDiv);
            }
        }

        // Toggle tracking checkbox
        function toggleTracking(week, day, habitId) {
            trackingData[week][day][habitId] = !trackingData[week][day][habitId];
            updateCharts();
            renderTopHabits();
        }

        // Toggle habit completion for today
        function toggleHabitComplete(habitId) {
            const today = new Date().getDay() || 7;
            trackingData[currentWeekStart][today][habitId] = !trackingData[currentWeekStart][today][habitId];
            renderWeeks();
            updateCharts();
            renderTopHabits();
        }

        // Week navigation
        function previousWeek() {
            if (currentWeekStart > 1) {
                currentWeekStart--;
                renderWeeks();
                saveToDatabase();
            }
        }

        function nextWeek() {
            if (currentWeekStart < totalWeeks - 1) {
                currentWeekStart++;
                renderWeeks();
                saveToDatabase();
            }
        }

        // Add new week
        function addWeek() {
            totalWeeks++;
            const weeks = totalWeeks;
            const days = 7;
            
            // Initialize tracking for new week with all unchecked
            trackingData[weeks] = {};
            for (let d = 1; d <= days; d++) {
                trackingData[weeks][d] = {};
                habits.forEach(habit => {
                    trackingData[weeks][d][habit.id] = false;
                });
            }
            
            // Initialize dates for new week
            initializeWeekDates();
            
            renderWeeks();
            updateCharts();
            renderTopHabits();
            closeAddWeekModal();
            showNotification(`‚úì Week ${weeks} added (${getDateRange(weeks)})!`, 'success');
        }

        // Calculate overall monthly percentage
        function calculateMonthlyPercentage() {
            let totalCompleted = 0;
            let totalPossible = 0;

            for (let w = 1; w <= 5; w++) {
                for (let d = 1; d <= 7; d++) {
                    habits.forEach(habit => {
                        totalPossible++;
                        if (trackingData[w][d][habit.id]) {
                            totalCompleted++;
                        }
                    });
                }
            }

            return Math.round((totalCompleted / totalPossible) * 100);
        }

        // Calculate completion rates per week
        function getWeeklyCompletionRates() {
            const rates = [];
            for (let w = 1; w <= totalWeeks; w++) {
                let completed = 0;
                let total = 0;
                for (let d = 1; d <= 7; d++) {
                    habits.forEach(habit => {
                        total++;
                        if (trackingData[w][d][habit.id]) {
                            completed++;
                        }
                    });
                }
                rates.push(Math.round((completed / total) * 100));
            }
            return rates;
        }

        // Calculate top habits
        function getTopHabits() {
            const habitScores = {};
            habits.forEach(habit => {
                habitScores[habit.id] = { name: habit.name, icon: habit.icon, completed: 0, total: 0 };
            });

            for (let w = 1; w <= totalWeeks; w++) {
                for (let d = 1; d <= 7; d++) {
                    habits.forEach(habit => {
                        habitScores[habit.id].total++;
                        if (trackingData[w][d][habit.id]) {
                            habitScores[habit.id].completed++;
                        }
                    });
                }
            }

            return Object.values(habitScores)
                .map(h => ({
                    ...h,
                    percentage: h.total > 0 ? Math.round((h.completed / h.total) * 100) : 0
                }))
                .sort((a, b) => b.percentage - a.percentage)
                .slice(0, 10);
        }

        // Render top habits
        function renderTopHabits() {
            const topHabits = getTopHabits();
            const topHabitsDiv = document.getElementById('topHabits');
            topHabitsDiv.innerHTML = topHabits.map((habit, index) => `
                <div class="top-habit">
                    <span class="habit-rank">${index + 1}</span>
                    <span class="habit-name-progress">${habit.name}</span>
                    <span class="habit-completion">${habit.percentage}%</span>
                </div>
            `).join('');
        }

        // Update charts
        let trendChart, barChart;

        function updateCharts() {
            const monthlyPercentage = calculateMonthlyPercentage();
            document.getElementById('monthlyPercentage').textContent = monthlyPercentage + '%';

            const weeklyRates = getWeeklyCompletionRates();

            // Trend Chart
            if (trendChart) trendChart.destroy();
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const trendLabels = Array.from({length: totalWeeks}, (_, i) => `Week ${i + 1}`);
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Completion Rate %',
                        data: weeklyRates,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });

            // Bar Chart
            if (barChart) barChart.destroy();
            const barCtx = document.getElementById('barChart').getContext('2d');
            const barLabels = Array.from({length: totalWeeks}, (_, i) => `Week ${i + 1}`);
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'Completion Rate %',
                        data: weeklyRates,
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        // Modal functions
        function openAddHabitModal() {
            document.getElementById('addHabitModal').classList.add('active');
        }

        function closeAddHabitModal() {
            document.getElementById('addHabitModal').classList.remove('active');
            document.getElementById('habitNameInput').value = '';
            document.getElementById('habitIconInput').value = '';
            document.getElementById('habitGoalInput').value = '30';
        }

        function addHabit() {
            const name = document.getElementById('habitNameInput').value.trim();

            if (!name) {
                showNotification('Please enter a habit name', 'error');
                return;
            }

            const newId = habits.length > 0 ? Math.max(...habits.map(h => h.id)) + 1 : 1;
            habits.push({ id: newId, name });

            // Initialize tracking for new habit across all weeks
            for (let w = 1; w <= totalWeeks; w++) {
                for (let d = 1; d <= 7; d++) {
                    if (!trackingData[w]) trackingData[w] = {};
                    if (!trackingData[w][d]) trackingData[w][d] = {};
                    trackingData[w][d][newId] = false;
                }
            }

            renderHabits();
            renderWeeks();
            updateCharts();
            renderTopHabits();
            closeAddHabitModal();
            showNotification(`‚úì "${name}" added!`, 'success');
        }

        // Delete habit with confirmation
        function deleteHabit(habitId, habitName) {
            // Unescape the habit name properly
            const displayName = habitName.replace(/\\'/g, "'");
            
            if (confirm(`Are you sure you want to delete "${displayName}"?`)) {
                console.log('Deleting habit:', habitId, displayName);
                
                // Remove from habits array
                habits = habits.filter(h => h.id !== habitId);
                console.log('Habits after filter:', habits.length);
                
                // Remove from tracking data across ALL weeks
                for (let w = 1; w <= totalWeeks; w++) {
                    if (trackingData[w]) {
                        for (let d = 1; d <= 7; d++) {
                            if (trackingData[w][d] && trackingData[w][d][habitId]) {
                                delete trackingData[w][d][habitId];
                            }
                        }
                    }
                }
                
                // Re-render everything in correct order
                renderHabits();
                renderWeeks();
                updateCharts();
                renderTopHabits();
                showNotification(`‚úì "${displayName}" deleted!`, 'success');
            }
        }

        // Edit habit modal functions
        let editingHabitId = null;

        function openEditHabitModal(habitId, habitName) {
            editingHabitId = habitId;
            document.getElementById('editHabitNameInput').value = habitName;
            document.getElementById('editHabitModal').classList.add('active');
            document.getElementById('editHabitNameInput').focus();
        }

        function closeEditHabitModal() {
            document.getElementById('editHabitModal').classList.remove('active');
            editingHabitId = null;
            document.getElementById('editHabitNameInput').value = '';
        }

        function saveEditedHabit() {
            const newName = document.getElementById('editHabitNameInput').value.trim();

            if (!newName) {
                showNotification('Please enter a habit name', 'error');
                return;
            }

            const habit = habits.find(h => h.id === editingHabitId);
            if (habit) {
                const oldName = habit.name;
                habit.name = newName;
                
                renderHabits();
                renderWeeks();
                updateCharts();
                renderTopHabits();
                closeEditHabitModal();
                showNotification(`‚úì "${oldName}" ‚Üí "${newName}"!`, 'success');
            }
        }

        // Modal functions for Add Week
        function openAddWeekModal() {
            document.getElementById('addWeekModal').classList.add('active');
        }

        function closeAddWeekModal() {
            document.getElementById('addWeekModal').classList.remove('active');
        }

        // Show notification toast
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Append to body safely
            if (document.body) {
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
        }

        // IndexedDB Setup for Persistent Storage
        const DB_NAME = 'HabitsTrackerDB';
        const DB_VERSION = 1;
        let db;

        // Initialize IndexedDB
        function initializeDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Create object stores
                    if (!db.objectStoreNames.contains('habits')) {
                        db.createObjectStore('habits', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('trackingData')) {
                        db.createObjectStore('trackingData', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' });
                    }
                };
            });
        }

        // Save data to IndexedDB
        function saveToDatabase() {
            if (!db) return;
            
            const transaction = db.transaction(['habits', 'trackingData', 'metadata'], 'readwrite');
            
            // Save habits
            const habitsStore = transaction.objectStore('habits');
            habitsStore.clear();
            habits.forEach(habit => {
                habitsStore.put(habit);
            });
            
            // Save tracking data
            const trackingStore = transaction.objectStore('trackingData');
            trackingStore.clear();
            for (let w in trackingData) {
                for (let d in trackingData[w]) {
                    for (let h in trackingData[w][d]) {
                        trackingStore.put({
                            week: parseInt(w),
                            day: parseInt(d),
                            habitId: parseInt(h),
                            completed: trackingData[w][d][h]
                        });
                    }
                }
            }
            
            // Save metadata
            const metadataStore = transaction.objectStore('metadata');
            metadataStore.put({ key: 'totalWeeks', value: totalWeeks });
            metadataStore.put({ key: 'currentWeekStart', value: currentWeekStart });
            metadataStore.put({ key: 'lastUpdated', value: new Date().toISOString() });
        }

        // Load data from IndexedDB
        function loadFromDatabase() {
            return new Promise((resolve) => {
                if (!db) {
                    resolve();
                    return;
                }
                
                const transaction = db.transaction(['habits', 'trackingData', 'metadata'], 'readonly');
                
                // Load habits
                const habitsStore = transaction.objectStore('habits');
                habitsStore.getAll().onsuccess = (event) => {
                    if (event.target.result.length > 0) {
                        habits = event.target.result;
                    }
                };
                
                // Load tracking data
                const trackingStore = transaction.objectStore('trackingData');
                trackingStore.getAll().onsuccess = (event) => {
                    trackingData = {};
                    event.target.result.forEach(record => {
                        const w = record.week;
                        const d = record.day;
                        const h = record.habitId;
                        
                        if (!trackingData[w]) trackingData[w] = {};
                        if (!trackingData[w][d]) trackingData[w][d] = {};
                        trackingData[w][d][h] = record.completed;
                    });
                };
                
                // Load metadata
                const metadataStore = transaction.objectStore('metadata');
                metadataStore.get('totalWeeks').onsuccess = (event) => {
                    if (event.target.result) {
                        totalWeeks = event.target.result.value;
                    }
                };
                metadataStore.get('currentWeekStart').onsuccess = (event) => {
                    if (event.target.result) {
                        currentWeekStart = event.target.result.value;
                    }
                };
                
                transaction.oncomplete = () => {
                    resolve();
                };
            });
        }

        // Page Navigation
        function switchPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageName).classList.add('active');
            
            // Activate selected tab
            event.target.classList.add('active');
            
            // Render yearly if switching to yearly
            if (pageName === 'yearly') {
                renderYearlyTracker();
            }
        }

        // Week dates tracking - starts Dec 27, 2025 (Saturday)
        function initializeWeekDates() {
            const startDate = new Date(2025, 11, 27); // Dec 27, 2025 (Saturday)
            
            for (let w = 1; w <= totalWeeks; w++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(weekStart.getDate() + (w - 1) * 7);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weekDates[w] = {
                    startDate: formatDate(weekStart),
                    endDate: formatDate(weekEnd),
                    startMonth: weekStart.getMonth() + 1,
                    endMonth: weekEnd.getMonth() + 1,
                    startYear: weekStart.getFullYear(),
                    endYear: weekEnd.getFullYear(),
                    startDateObj: weekStart,
                    endDateObj: weekEnd
                };
            }
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'short' });
            const year = date.getFullYear();
            const dayName = date.toLocaleString('default', { weekday: 'short' });
            return `${dayName}, ${day} ${month} ${year}`;
        }

        function getDateRange(week) {
            if (weekDates[week]) {
                const startDate = weekDates[week].startDate;
                const endDate = weekDates[week].endDate;
                return `${startDate} - ${endDate}`;
            }
            return '';
        }

        // Calculate monthly progress using dates
        function getMonthlyProgressByDates() {
            const monthData = {};
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            for (let w = 1; w <= totalWeeks; w++) {
                if (!weekDates[w]) continue;
                
                const startMonthKey = `${weekDates[w].startMonth}/${weekDates[w].startYear}`;
                const endMonthKey = `${weekDates[w].endMonth}/${weekDates[w].endYear}`;
                
                // Initialize month data for start month
                if (!monthData[startMonthKey]) {
                    monthData[startMonthKey] = {
                        month: monthNames[weekDates[w].startMonth - 1],
                        monthNum: weekDates[w].startMonth,
                        year: weekDates[w].startYear,
                        weeks: [],
                        completed: 0,
                        total: 0
                    };
                }
                
                // Initialize month data for end month (if different)
                if (endMonthKey !== startMonthKey && !monthData[endMonthKey]) {
                    monthData[endMonthKey] = {
                        month: monthNames[weekDates[w].endMonth - 1],
                        monthNum: weekDates[w].endMonth,
                        year: weekDates[w].endYear,
                        weeks: [],
                        completed: 0,
                        total: 0
                    };
                }
                
                monthData[startMonthKey].weeks.push(w);
                if (endMonthKey !== startMonthKey) {
                    monthData[endMonthKey].weeks.push(w);
                }
                
                // Count completed habits for this week
                for (let d = 1; d <= 7; d++) {
                    if (trackingData[w] && trackingData[w][d]) {
                        habits.forEach(habit => {
                            monthData[startMonthKey].total++;
                            if (endMonthKey !== startMonthKey) {
                                monthData[endMonthKey].total++;
                            }
                            if (trackingData[w][d][habit.id]) {
                                monthData[startMonthKey].completed++;
                                if (endMonthKey !== startMonthKey) {
                                    monthData[endMonthKey].completed++;
                                }
                            }
                        });
                    }
                }
            }
            
            return monthData;
        }

        // Calculate monthly progress (legacy - for backwards compatibility)
        function getMonthlyProgress() {
            const monthData = getMonthlyProgressByDates();
            const sortedMonths = Object.entries(monthData)
                .sort((a, b) => {
                    const aDate = new Date(a[1].year, a[1].monthNum - 1);
                    const bDate = new Date(b[1].year, b[1].monthNum - 1);
                    return aDate - bDate;
                })
                .map(([key, data]) => ({
                    ...data,
                    percentage: data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0
                }));
            
            return sortedMonths;
        }

        // Render yearly tracker
        function renderYearlyTracker() {
            const monthlyData = getMonthlyProgress();
            const container = document.getElementById('yearlyContainer');
            
            container.innerHTML = monthlyData.map(month => {
                const percentage = month.total > 0 ? Math.round((month.completed / month.total) * 100) : 0;
                let status = 'poor';
                if (percentage >= 80) status = 'excellent';
                else if (percentage >= 60) status = 'good';
                else if (percentage >= 40) status = 'fair';
                
                // Get date ranges from weeks
                const weekRanges = month.weeks.map(w => getDateRange(w)).join(', ');
                
                return `
                    <div class="month-card ${status}">
                        <div class="month-header">
                            <div>
                                <div class="month-name">${month.month}</div>
                                <div class="month-year">${month.year}</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-bottom: 10px; text-align: center;">${weekRanges}</div>
                        <div class="month-percentage">${percentage}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="month-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Habits:</span>
                                <span class="stat-value">${habits.length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Completed Days:</span>
                                <span class="stat-value">${Math.round(month.completed / habits.length)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Status:</span>
                                <span class="stat-value">${status.toUpperCase()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize on page load - CRITICAL ORDER
        async function startApp() {
            try {
                await initializeDB();
                await loadFromDatabase();
                
                // Initialize missing tracking data
                initializeTrackingData();
                
                // Initialize week dates (CRITICAL - must be after totalWeeks is set)
                initializeWeekDates();
                
                // Render UI
                renderHabits();
                renderWeeks();
                updateCharts();
                renderTopHabits();
                
                showNotification('‚úì App loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading app:', error);
                // Fallback to in-memory if DB fails
                initializeTrackingData();
                initializeWeekDates();
                renderHabits();
                renderWeeks();
                updateCharts();
                renderTopHabits();
            }
        }

        // Modified save calls - auto-save after every action
        const originalRenderHabits = renderHabits;
        renderHabits = function() {
            originalRenderHabits();
            saveToDatabase();
        };

        const originalToggleTracking = toggleTracking;
        toggleTracking = function(week, day, habitId) {
            originalToggleTracking(week, day, habitId);
            saveToDatabase();
        };

        const originalAddWeek = addWeek;
        addWeek = function() {
            originalAddWeek();
            saveToDatabase();
        };

        // Start the app
        startApp();
    </script>
</body>
</html>

